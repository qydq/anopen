﻿---
title:  "Android开发中屏幕dpi资源适配总结"
date:   2014-10-26 14:30
categories: Story
---

Android开发中屏幕dpi资源适配总结
===================
简介
-------------

Android中经常要通过ImageView进行图片资源显示。在加载图片时，首先要考虑的两个因素就是**体验问题**和**性能问题**。


>  - **体验问题**是指图片显示的是否正确（例如Universal-Image-Loader在适配Adapter图片资源时会导致图片显示错位），分辨率是否合适等。
>  - **性能问题**主要是指图片加载速度，以及更加重要的图片加载的内存占用问题。本文重点介绍ImageView加载图片中的内存占用问题。

问题
-------------

在开发的过程中，一般会将不同分辨率的图片放置在不同的文件夹中，例如将三种同样内容不同分辨率的图片分别放置在drawable-xhdpi，drawable-xxhdpi和drawable-xxxhdpi中。那么，为什么要放置不同分辨率的图片，只放置一张对图片的显示有影响吗？本文中将对这个问题进行分析。

概念描述
-------------

图片对内存的占用是一个叠加的过程，也就是说图片资源不是及时释放的，使用过的图片在回收过程中可能会有一定程度的延迟。此外，很多时候图片所依附的Activity是处于当前Activity栈底的状态，在GC回收过程中，这样的bitmap资源会被认为是活跃状态的，不会被Android系统回收。
另外一方面，Android中图片加载到内存中的内存占用跟图片的实际大小没有直接的关系，甚至于图片的实际像素尺寸也没有直接的关系。
>内存中实际占用大小与图片分辨率、像素显示参数（如Bitmap.Config）有关。所以，在一个App里面使用一套UI理论上应该是没有问题的，但是[<i class="icon-refresh"></i> 注意](#注意) 。

在这里，首先要介绍几个概念(以图片A：尺寸60*60 大小2.02K为例)：

- **屏幕尺寸**：指屏幕的对角线的长度，单位是英寸，1英寸=2.54厘米；
- **屏幕分辨率**：指在横纵向上的像素点数，单位是px，1px=1个像素点。一般以纵向像素*横向像素，如1960*1080；
- **屏幕像素密度**：是指每英寸上的像素点数，单位是dpi，即“dot per inch”的缩写。屏幕像素密度与屏幕尺寸和屏幕分辨率有关，在单一变化条件下，屏幕尺寸越小、分辨率越高，像素密度越大，反之越小；
- **dp/dip**：Density Independent Pixels, 密度无关像素的缩写；
- **px**：像素，物理上的绝对单位；
- **sp**：Scale-Independent Pixels的缩写。

*一般而言，会有控件使用dp而文字使用sp的说法，但是也不尽然，sp会随着系统文字大小进行拉伸，而dp不会，再具体使用过程中还是要根据实际情况进行使用。*


屏幕dpi资源适配
-------------
屏幕dpi资源适配，就是要在在不同的dpi文件夹中放置不同尺寸的图像资源，供设备自动跳转要显示的资源。以mdpi为尺寸基准1x，dpi适配可以表示如下：

![图1. 多dpi资源适配](http://www.itnose.net/img/20160729/65132.png)
图1. 屏幕dpi资源适配图

tips：这里说明了开发时应该图片以160dpi为基准，同时提供不同dpi的基于baseline的图片的放大或者缩小版本。

**####mdpi、hdpi、xdpi、xxdpi用来修饰Android中的drawable文件夹及values文件夹，用来区分不同像素密度下的图片和dimen值。**

那么如何区分呢？Google官方指定按照下列标准进行区分：屏幕dpi资源适配图可以表示如下：

![enter image description here](http://www.itnose.net/img/20160729/65133.png)
图2. 屏幕dpi资源适配像素密度图

在进行开发的时候，我们需要把合适大小的图片放在合适的文件夹里面。下面以图标设计为例进行介绍。

: 在设计图标时，对于五种主流的像素密度（MDPI、HDPI、XHDPI、XXHDPI 和 XXXHDPI）应按照 2:3:4:6:8 的比例进行缩放。例如，一个启动图标的尺寸为48x48 dp，这表示在 MDPI 的屏幕上其实际尺寸应为 48x48 px，在 HDPI 的屏幕上其实际大小是 MDPI 的 1.5 倍 (72x72 px)，在 XDPI 的屏幕上其实际大小是 MDPI 的 2 倍 (96x96 px)，依此类推。

虽然 Android 也支持低像素密度 (LDPI) 的屏幕，但无需为此费神，系统会自动将 HDPI 尺寸的图标缩小到 1/2 进行匹配。

下图为图标的各个屏幕密度的对应尺寸
![enter image description here](http://www.itnose.net/img/20160729/65134.png)

Android系统寻找图片的步骤是这样的：
```
(1).	去屏幕密度对应的目录去找。如果找到就拿来用。
(2).	如果没找到，就去比这个密度高一级的目录里面去找，如果找到就拿来用。
(3).	如果没找到就继续往上找。以此类推。
(4).	如果到了xxhdpi目录还没有找到的话，就会去比自身屏幕密度低一级的目录去找，如果低一级的目录>=hdpi，找到了就拿来用。
(5).	如果没找到， 就去mdpi目录去找， 如果找到了，就拿来用。
(6).	如果没找到，就去默认的drawble目录里去找， 如果找到了就拿来用。
(7).	如果没找到，再去最低的ldpi目录里去找。如果找到了，就拿来用。
(8).	如果没找到， 那就是没找到了， 图片无法显示。（不过一般不会出现这种现象，因为如果每个目录都没有这个图片的话，你是编译不过的）
```
如果不是在对应目录里面找到的图片资源，要根据实际使用情况，进行显示，根据显示模式的不同，主要有以下两种情况：

(1).	MeasureSpec.EXACTLY
这种情况下，图片的布局规则为match_parent或者是具体大小的数值(如layout_width =60dp, layout_height=60dp)，这种情况下，图片的显示尺寸是固定的，所以显示的大小不会因为所在的资源文件夹dpi的不同而有所变化；
(2).	MeasureSpec.AT_MOST
这种情况下，图片的布局规则为wrap_content。系统会根据图像内容的实际大小进行显示。同一张图片放在不同文件夹显示大小会有所不同，具体而言，同一张图像资源放置在mdpi/hdpi/xhdpi/xxhdpi/xxxhdpi里面，显示的大小比较分别为：2:3:4:6:8。

**但是，在进行多dpi适配的时候，本身放置在mdpi/hdpi/xhdpi/xxhdpi/xxxhdpi里面的图像资源尺寸比较就是2:3:4:6:8，二者完美抵消，所以当前模式下，只放置一张合适尺寸的图像资源在一个合适的文件夹里面，不会影响不同尺寸设备的显示效果。**
例如wrap_content布局下，分别将分别将同一张图像A(尺寸60*60 大小2.02K)和图像B(尺寸30*30 大小2.02K)放置在xxhdpi和hdpi资源文件夹中，他们的显示效果是一样的。


注意 
-------------

- 最好使用较高分辨率的切图，并且放置在正确的drawable文件夹中，比如按照xxhdpi的分辨率进行切图，放置在drawable-xxhdpi中
- 对于可以使用.9格式的图片，最好使用.9，减少资源大小
- 如果有条件，最好提供多套UI切图。如果只有一套切图，系统需要对图片进行压缩，会进行大量运算，影响设备性能。同时，在某些情况下，系统对图片的压缩会可能会出现锯齿，造成信息的丢失
- 如果是多套切图的话，最好不要直接用工具按照比例放缩，这样小图标会丢失一些细节。当然，这部分是美工来做的，可以让她参考这篇文章利用PS CS6的新功能保持ICON细节饱满完美

思考一下，如果把一个本来应该放在drawable-xxhdpi里面的图片放在了drawable文件夹中会出现什么问题呢？

在xxhdpi设备上，图片会被放大3倍，图片内存占用就会变为原来的9倍！

总结
-------------
经过上面的分析，可以得出结论：

在不同显示模式下，如果只放置一张合适尺寸的图片资源在合适的文件夹，是可以实现不同设备的多dpi适配。考虑到分辨率和使用率的问题，建议保留xxhdpi文件夹下的图像资源。

参考文献
-------------
(1).	http://www.cnblogs.com/zhwl/archive/2013/06/12/3132722.html
(2).	http://blog.csdn.net/skykingf/article/details/45536143
(3).	http://www.itnose.net/detail/6614353.html

